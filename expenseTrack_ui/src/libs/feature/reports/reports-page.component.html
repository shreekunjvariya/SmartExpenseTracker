<div class="page" data-testid="reports-page">
  <header class="page-header">
    <h1>Reports</h1>
    <p>Analyze spending patterns and export data</p>
  </header>

  <p class="error" *ngIf="error">{{ error }}</p>
  <p class="success" *ngIf="success">{{ success }}</p>

  <nav class="tabs">
    <button type="button" [class.active]="activeTab === 'overview'" (click)="setTab('overview')" data-testid="tab-overview">
      Overview
    </button>
    <button type="button" [class.active]="activeTab === 'export'" (click)="setTab('export')" data-testid="tab-export">
      Export
    </button>
    <button type="button" [class.active]="activeTab === 'import'" (click)="setTab('import')" data-testid="tab-import">
      Import
    </button>
  </nav>

  <section *ngIf="activeTab === 'overview'" class="tab-panel">
    <div class="period-switch">
      <button
        type="button"
        *ngFor="let value of ['week', 'month', 'year']"
        [class.active]="period === value"
        (click)="setPeriodFromString(value)"
        [attr.data-testid]="'period-' + value"
      >
        {{ value | titlecase }}
      </button>
    </div>

    <div class="loading" *ngIf="loading">Loading report data...</div>

    <ng-container *ngIf="!loading">
      <div class="summary-grid">
        <article class="summary-card">
          <p>Total Spent ({{ period }})</p>
          <strong>{{ formatCurrency(total) }}</strong>
          <small>{{ summary?.count || 0 }} transactions</small>
        </article>

        <article class="summary-card">
          <p>Top Category</p>
          <strong>{{ topCategory?.name || 'No data' }}</strong>
          <small *ngIf="topCategory">{{ formatCurrency(topCategory.total) }}</small>
        </article>

        <article class="summary-card">
          <p>Daily Average</p>
          <strong>{{ formatCurrency(dailyAverage) }}</strong>
          <small>per day</small>
        </article>
      </div>

      <article class="card">
        <h2>Detailed Breakdown</h2>
        <div class="empty" *ngIf="!(summary?.by_category?.length)">No expense data for this period.</div>

        <div class="category-list" *ngIf="summary?.by_category?.length">
          <div class="category-item" *ngFor="let category of summary?.by_category">
            <div class="left">
              <span class="dot" [style.backgroundColor]="category.color || '#064E3B'"></span>
              <div>
                <p>{{ category.name }}</p>
                <small>{{ category.count }} transactions</small>
              </div>
            </div>
            <div class="right">
              <strong>{{ formatCurrency(category.total) }}</strong>
              <small>{{ categoryPercent(category.total) }}% of total</small>
            </div>
          </div>
        </div>
      </article>
    </ng-container>
  </section>

  <section *ngIf="activeTab === 'export'" class="tab-panel">
    <article class="card">
      <h2>Export Expenses to CSV</h2>
      <p class="muted">Select a date range and download your expenses as a CSV file.</p>

      <div class="date-grid">
        <div class="field">
          <label for="fromDate">From</label>
          <input id="fromDate" type="date" [(ngModel)]="fromDate" data-testid="export-from-date" />
        </div>
        <div class="field">
          <label for="toDate">To</label>
          <input id="toDate" type="date" [(ngModel)]="toDate" data-testid="export-to-date" />
        </div>
      </div>

      <button type="button" class="btn-primary" (click)="exportCsv()" data-testid="export-btn">Download CSV</button>

      <div class="hint">
        <p>CSV Format:</p>
        <code>Date,Description,Amount,Currency,Category,Subcategory</code>
      </div>
    </article>
  </section>

  <section *ngIf="activeTab === 'import'" class="tab-panel">
    <article class="card">
      <h2>Import Expenses from CSV</h2>

      <div class="hint">
        <p>Required CSV format:</p>
        <code>Date,Description,Amount,Currency,Category,Subcategory</code>
        <code>2024-01-15,Coffee,5.50,USD,Food &amp; Dining,Coffee &amp; Snacks</code>
      </div>

      <textarea
        [(ngModel)]="importData"
        placeholder="Paste your CSV data here (including header row)..."
        data-testid="import-textarea"
      ></textarea>

      <button
        type="button"
        class="btn-primary"
        [disabled]="importing || !importData.trim()"
        (click)="importCsv()"
        data-testid="import-btn"
      >
        {{ importing ? 'Importing...' : 'Import Expenses' }}
      </button>
    </article>
  </section>
</div>
