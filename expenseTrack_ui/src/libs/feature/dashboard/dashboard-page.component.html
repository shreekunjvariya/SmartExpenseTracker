<div class="page" data-testid="dashboard-page">
  <div class="page-header">
    <div>
      <h1>Dashboard</h1>
      <p>Welcome back, {{ user?.name?.split(' ')[0] || 'User' }}</p>
    </div>
    <a routerLink="/expenses" class="btn-primary" data-testid="add-expense-btn">Add Expense</a>
  </div>

  <p class="error" *ngIf="error">{{ error }}</p>

  <div class="loading" *ngIf="loading">Loading dashboard...</div>

  <ng-container *ngIf="!loading">
    <section class="stats-grid">
      <article class="stat-card" *ngFor="let stat of statCards; let i = index" [attr.data-testid]="'stat-card-' + i">
        <div class="stat-top">
          <p class="stat-title">{{ stat.title }}</p>
          <span class="trend" *ngIf="stat.trend" [class.up]="stat.trend.direction === 'up'" [class.down]="stat.trend.direction === 'down'">
            {{ stat.trend.direction === 'up' ? '+' : '-' }}{{ stat.trend.value }}%
          </span>
        </div>
        <p class="stat-value">{{ stat.value }}</p>
        <p class="stat-subtext">{{ stat.subtext }}</p>
      </article>
    </section>

    <section class="insights-grid">
      <article class="card">
        <header>
          <h2>By Category</h2>
        </header>
        <div *ngIf="topCategories.length; else noCategoryData">
          <div class="category-row" *ngFor="let category of topCategories">
            <div class="category-head">
              <span class="category-name">{{ category.name }}</span>
              <span class="category-value">{{ formatCurrency(category.total) }}</span>
            </div>
            <div class="category-bar">
              <div
                class="category-fill"
                [style.width.%]="(category.total / maxCategoryTotal) * 100"
                [style.backgroundColor]="category.color || '#064E3B'"
              ></div>
            </div>
          </div>
        </div>
        <ng-template #noCategoryData>
          <p class="placeholder">No expense data yet.</p>
        </ng-template>
      </article>

      <article class="card">
        <header>
          <h2>Daily Spending</h2>
        </header>
        <div *ngIf="dailyTrendRows.length; else noDailyData" class="trend-list">
          <div class="trend-row" *ngFor="let row of dailyTrendRows">
            <span>{{ row.label }}</span>
            <strong>{{ row.amount }}</strong>
          </div>
        </div>
        <ng-template #noDailyData>
          <p class="placeholder">No expense data yet.</p>
        </ng-template>
      </article>
    </section>

    <section class="quick-actions">
      <a routerLink="/expenses" class="action-card">
        <h3>View All Expenses</h3>
        <p>Manage your expense history.</p>
      </a>
      <a routerLink="/categories" class="action-card">
        <h3>Manage Categories</h3>
        <p>Customize your category structure.</p>
      </a>
      <a routerLink="/reports" class="action-card">
        <h3>Generate Reports</h3>
        <p>Export and analyze spending data.</p>
      </a>
    </section>
  </ng-container>
</div>
