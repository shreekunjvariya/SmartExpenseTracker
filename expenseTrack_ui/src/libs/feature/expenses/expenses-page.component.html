<div class="page" data-testid="expenses-page">
  <div class="page-header">
    <div>
      <h1>Expenses</h1>
      <p>Track and manage your spending</p>
    </div>
    <button type="button" class="btn-primary" (click)="openAddDialog()" data-testid="add-expense-dialog-btn">
      Add Expense
    </button>
  </div>

  <p class="error" *ngIf="error">{{ error }}</p>
  <p class="success" *ngIf="success">{{ success }}</p>

  <section class="filters">
    <input
      type="search"
      placeholder="Search expenses..."
      [(ngModel)]="searchTerm"
      data-testid="expense-search-input"
    />
    <select [(ngModel)]="filterCategory" data-testid="expense-filter-select">
      <option value="all">All Categories</option>
      <option *ngFor="let category of categories" [value]="category.category_id">{{ category.name }}</option>
    </select>
  </section>

  <section class="list-card">
    <div class="loading" *ngIf="loading">Loading expenses...</div>

    <div class="empty" *ngIf="!loading && !filteredExpenses.length">
      No expenses found. Add your first expense.
    </div>

    <article
      class="expense-item"
      *ngFor="let expense of filteredExpenses"
      [attr.data-testid]="'expense-item-' + expense.expense_id"
    >
      <div class="left">
        <div class="avatar" [style.backgroundColor]="getCategory(expense.category_id)?.color || '#064E3B'">
          {{ getCategory(expense.category_id)?.name?.charAt(0) || 'E' }}
        </div>
        <div class="copy">
          <p class="description">{{ expense.description }}</p>
          <p class="meta">
            {{ getCategory(expense.category_id)?.name || 'Category' }}
            <span *ngIf="getSubcategory(expense.category_id, expense.subcategory_id)">
              > {{ getSubcategory(expense.category_id, expense.subcategory_id) }}
            </span>
          </p>
        </div>
      </div>

      <div class="right">
        <div class="amount-wrap">
          <p class="amount">{{ formatCurrency(expense.amount, expense.currency) }}</p>
          <p class="date">{{ formatDate(expense.date) }}</p>
        </div>
        <div class="actions">
          <button type="button" class="icon-btn" (click)="openEditDialog(expense)" [attr.data-testid]="'edit-expense-' + expense.expense_id">
            Edit
          </button>
          <button
            type="button"
            class="icon-btn danger"
            (click)="deleteExpense(expense)"
            [attr.data-testid]="'delete-expense-' + expense.expense_id"
          >
            Delete
          </button>
        </div>
      </div>
    </article>
  </section>
</div>

<div class="modal-backdrop" *ngIf="dialogOpen">
  <div class="modal">
    <div class="modal-header">
      <h2>{{ editingExpense ? 'Edit Expense' : 'Add New Expense' }}</h2>
      <button type="button" class="close-btn" (click)="closeDialog()">X</button>
    </div>

    <form [formGroup]="form" (ngSubmit)="saveExpense()">
      <div class="field-grid">
        <div class="field">
          <label for="amount">Amount</label>
          <input
            id="amount"
            type="number"
            step="0.01"
            formControlName="amount"
            placeholder="0.00"
            data-testid="expense-amount-input"
          />
        </div>

        <div class="field">
          <label for="currency">Currency</label>
          <select id="currency" formControlName="currency" data-testid="expense-currency-select">
            <option *ngFor="let currency of currencies" [value]="currency.code">{{ currency.label }}</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="description">Description</label>
        <input
          id="description"
          type="text"
          formControlName="description"
          placeholder="What did you spend on?"
          data-testid="expense-description-input"
        />
      </div>

      <div class="field">
        <label for="category">Category</label>
        <select
          id="category"
          formControlName="category_id"
          (change)="onCategoryChange()"
          data-testid="expense-category-select"
        >
          <option value="">Select category</option>
          <option *ngFor="let category of categories" [value]="category.category_id">{{ category.name }}</option>
        </select>
      </div>

      <div class="field" *ngIf="selectedCategory?.subcategories?.length">
        <label for="subcategory">Subcategory (Optional)</label>
        <select id="subcategory" formControlName="subcategory_id" data-testid="expense-subcategory-select">
          <option value="">Select subcategory</option>
          <option
            *ngFor="let subcategory of selectedCategory?.subcategories || []"
            [value]="subcategory.subcategory_id"
          >
            {{ subcategory.name }}
          </option>
        </select>
      </div>

      <div class="field">
        <label for="date">Date</label>
        <input id="date" type="date" formControlName="date" data-testid="expense-date-btn" />
      </div>

      <button type="submit" class="btn-primary full" [disabled]="saving" data-testid="expense-submit-btn">
        {{ saving ? 'Saving...' : editingExpense ? 'Update Expense' : 'Add Expense' }}
      </button>
    </form>
  </div>
</div>
