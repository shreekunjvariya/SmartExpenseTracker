<div class="page" data-testid="dashboard-page">
  <div class="page-header">
    <div>
      <h1>Dashboard</h1>
      <p>Welcome back, {{ user?.name?.split(' ')[0] || 'User' }}</p>
    </div>
    <div class="header-actions">
      <a [routerLink]="['/expenses']" [queryParams]="{ action: 'add-income' }" class="btn-secondary" data-testid="add-income-btn">Add Income</a>
      <a [routerLink]="['/expenses']" [queryParams]="{ action: 'add-expense' }" class="btn-primary" data-testid="add-expense-btn">Add Expense</a>
    </div>
  </div>

  <p class="error" *ngIf="error">{{ error }}</p>

  <div class="loading-skeleton" *ngIf="loading" aria-label="Loading dashboard">
    <section class="skeleton-stats-grid">
      <article class="skeleton-card" *ngFor="let _ of [1, 2, 3, 4]">
        <span class="skeleton skeleton-line skeleton-line-sm"></span>
        <span class="skeleton skeleton-line skeleton-line-lg"></span>
        <span class="skeleton skeleton-line skeleton-line-md"></span>
      </article>
    </section>

    <section class="skeleton-insights-grid">
      <article class="skeleton-card">
        <span class="skeleton skeleton-line skeleton-line-md"></span>
        <span class="skeleton skeleton-line"></span>
        <span class="skeleton skeleton-line"></span>
        <span class="skeleton skeleton-line skeleton-line-sm"></span>
      </article>
      <article class="skeleton-card">
        <span class="skeleton skeleton-line skeleton-line-md"></span>
        <span class="skeleton skeleton-line"></span>
        <span class="skeleton skeleton-line"></span>
        <span class="skeleton skeleton-line skeleton-line-sm"></span>
      </article>
    </section>
  </div>

  <ng-container *ngIf="!loading">
    <section class="stats-grid">
      <article class="stat-card" *ngFor="let stat of statCards; let i = index" [attr.data-testid]="'stat-card-' + i">
        <div class="stat-top">
          <p class="stat-title">{{ stat.title }}</p>
          <span class="trend" *ngIf="stat.trend" [class.up]="stat.trend.direction === 'up'" [class.down]="stat.trend.direction === 'down'">
            {{ stat.trend.direction === 'up' ? '+' : '-' }}{{ stat.trend.value }}%
          </span>
        </div>
        <p class="stat-value" [ngClass]="stat.valueClass">{{ stat.value }}</p>
        <p class="stat-subtext">{{ stat.subtext }}</p>
      </article>
    </section>

    <section class="insights-grid">
      <article class="card">
        <header>
          <h2>By Category</h2>
        </header>
        <div *ngIf="topCategories.length; else noCategoryData">
          <div class="category-row" *ngFor="let category of topCategories">
            <div class="category-head">
              <span class="category-name">
                {{ category.name }}
                <small class="type-chip" [class.income]="category.entry_type === 'income'" [class.expense]="category.entry_type !== 'income'">
                  {{ categoryTypeLabel(category.entry_type) }}
                </small>
              </span>
              <span class="category-value">{{ formatCategoryAmount(category) }}</span>
            </div>
            <div class="category-bar">
              <div
                class="category-fill"
                [style.width.%]="(category.total / maxCategoryTotal) * 100"
                [style.backgroundColor]="category.color || '#064E3B'"
              ></div>
            </div>
          </div>
        </div>
        <ng-template #noCategoryData>
          <p class="placeholder">No transaction data yet.</p>
        </ng-template>
      </article>

      <article class="card">
        <header>
          <h2>Daily Net (Month)</h2>
        </header>
        <div *ngIf="dailyTrendRows.length; else noDailyData" class="trend-list">
          <div class="trend-row" *ngFor="let row of dailyTrendRows">
            <span>{{ row.label }}</span>
            <strong>{{ row.amount }}</strong>
          </div>
        </div>
        <ng-template #noDailyData>
          <p class="placeholder">No transaction data yet.</p>
        </ng-template>
      </article>
    </section>

    <section class="quick-actions">
      <a routerLink="/expenses" class="action-card">
        <h3>View All Transactions</h3>
        <p>Manage your expense and income history.</p>
      </a>
      <a routerLink="/categories" class="action-card">
        <h3>Manage Categories</h3>
        <p>Customize your category structure.</p>
      </a>
      <a routerLink="/reports" class="action-card">
        <h3>Generate Reports</h3>
        <p>Export and analyze spending data.</p>
      </a>
    </section>
  </ng-container>
</div>
