<div class="page" data-testid="categories-page">
  <div class="page-header">
    <div>
      <h1>Categories</h1>
      <p>Organize your expenses with custom categories</p>
    </div>
    <button type="button" class="btn-primary" (click)="openAddCategoryDialog()" data-testid="add-category-btn">
      Add Category
    </button>
  </div>

  <p class="error" *ngIf="error">{{ error }}</p>
  <p class="success" *ngIf="success">{{ success }}</p>

  <nav class="type-switch">
    <button
      type="button"
      [class.active]="activeEntryType === 'expense'"
      (click)="setEntryType('expense')"
      data-testid="categories-expense-tab"
    >
      Expense Categories
    </button>
    <button
      type="button"
      [class.active]="activeEntryType === 'income'"
      (click)="setEntryType('income')"
      data-testid="categories-income-tab"
    >
      Income Categories
    </button>
  </nav>

  <section class="categories-skeleton" *ngIf="loading" aria-label="Loading categories">
    <article class="skeleton-category-card" *ngFor="let _ of [1, 2, 3, 4]">
      <div class="skeleton-category-row">
        <span class="skeleton skeleton-chip"></span>
        <div class="skeleton-title-wrap">
          <span class="skeleton skeleton-line skeleton-line-md"></span>
          <span class="skeleton skeleton-line skeleton-line-sm"></span>
        </div>
        <div class="skeleton-actions">
          <span class="skeleton skeleton-pill"></span>
          <span class="skeleton skeleton-pill"></span>
          <span class="skeleton skeleton-pill"></span>
        </div>
      </div>
    </article>
  </section>

  <section *ngIf="!loading && !filteredCategories.length" class="empty-card">
    <p>No categories yet. Create your first category.</p>
  </section>

  <section class="categories-list" *ngIf="!loading && filteredCategories.length">
    <article
      class="category-card"
      *ngFor="let category of filteredCategories"
      [attr.data-testid]="'category-card-' + category.category_id"
    >
      <div class="category-row">
        <button type="button" class="expand-btn" (click)="toggleExpanded(category.category_id)">
          <span class="color-chip" [style.backgroundColor]="category.color"></span>
          <span class="title-wrap">
            <strong>{{ category.name }}</strong>
            <small>{{ category.subcategories.length }} subcategories</small>
          </span>
          <span class="chevron">{{ expandedCategories[category.category_id] ? 'v' : '>' }}</span>
        </button>

        <div class="row-actions">
          <button
            type="button"
            class="icon-btn"
            (click)="openSubcategoryDialog(category.category_id)"
            [attr.data-testid]="'add-subcategory-' + category.category_id"
          >
            Add Sub
          </button>
          <button
            type="button"
            class="icon-btn"
            (click)="openEditCategoryDialog(category)"
            [attr.data-testid]="'edit-category-' + category.category_id"
          >
            Edit
          </button>
          <button
            type="button"
            class="icon-btn danger"
            (click)="deleteCategory(category)"
            [attr.data-testid]="'delete-category-' + category.category_id"
          >
            Delete
          </button>
        </div>
      </div>

      <div class="sub-list" *ngIf="expandedCategories[category.category_id]">
        <p class="sub-empty" *ngIf="!category.subcategories.length">No subcategories yet.</p>

        <div
          class="sub-row"
          *ngFor="let subcategory of category.subcategories"
          [attr.data-testid]="'subcategory-' + subcategory.subcategory_id"
        >
          <span>{{ subcategory.name }}</span>
          <button
            type="button"
            class="icon-btn danger"
            (click)="deleteSubcategory(category.category_id, subcategory.subcategory_id)"
            [attr.data-testid]="'delete-subcategory-' + subcategory.subcategory_id"
          >
            Delete
          </button>
        </div>
      </div>
    </article>
  </section>
</div>

<div class="modal-backdrop" *ngIf="categoryDialogOpen">
  <div class="modal">
    <div class="modal-header">
      <h2>{{ editingCategory ? 'Edit Category' : 'Create New Category' }}</h2>
      <button type="button" class="close-btn" (click)="closeCategoryDialog()">X</button>
    </div>

    <form [formGroup]="categoryForm" (ngSubmit)="saveCategory()">
      <div class="field">
        <label for="category-name">Category Name</label>
        <input id="category-name" type="text" formControlName="name" data-testid="category-name-input" />
      </div>

      <div class="field">
        <label for="category-icon">Icon</label>
        <input id="category-icon" type="text" formControlName="icon" placeholder="folder" />
      </div>

      <div class="field">
        <label>Color</label>
        <div class="color-grid">
          <button
            type="button"
            class="color-dot"
            *ngFor="let color of presetColors"
            [style.backgroundColor]="color"
            [class.selected]="categoryForm.controls.color.value === color"
            (click)="setColor(color)"
            [attr.data-testid]="'color-' + color"
          ></button>
        </div>
      </div>

      <div class="field">
        <label for="category-entry-type">Category Type</label>
        <select id="category-entry-type" formControlName="entry_type" data-testid="category-entry-type-select">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>

      <button type="submit" class="btn-primary full" [disabled]="savingCategory" data-testid="category-submit-btn">
        {{ savingCategory ? 'Saving...' : editingCategory ? 'Update Category' : 'Create Category' }}
      </button>
    </form>
  </div>
</div>

<div class="modal-backdrop" *ngIf="subDialogOpen">
  <div class="modal">
    <div class="modal-header">
      <h2>Add Subcategory</h2>
      <button type="button" class="close-btn" (click)="closeSubcategoryDialog()">X</button>
    </div>

    <p class="muted" *ngIf="selectedCategoryName">Parent: {{ selectedCategoryName }}</p>

    <form [formGroup]="subcategoryForm" (ngSubmit)="saveSubcategory()">
      <div class="field">
        <label for="subcategory-name">Subcategory Name</label>
        <input
          id="subcategory-name"
          type="text"
          formControlName="name"
          data-testid="subcategory-name-input"
        />
      </div>

      <div class="field">
        <label for="subcategory-icon">Icon</label>
        <input id="subcategory-icon" type="text" formControlName="icon" placeholder="tag" />
      </div>

      <button type="submit" class="btn-primary full" [disabled]="savingSubcategory" data-testid="subcategory-submit-btn">
        {{ savingSubcategory ? 'Saving...' : 'Add Subcategory' }}
      </button>
    </form>
  </div>
</div>
