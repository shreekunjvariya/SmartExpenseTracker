<div class="page" data-testid="reports-page">
  <header class="page-header">
    <div>
      <h1>Reports</h1>
      <p>Analyze and export your expenses and income.</p>
    </div>
  </header>

  <p class="error" *ngIf="error">{{ error }}</p>
  <p class="success" *ngIf="success">{{ success }}</p>

  <nav class="tabs">
    <button type="button" [class.active]="activeTab === 'overview'" (click)="setTab('overview')" data-testid="tab-overview">
      Overview
    </button>
    <button type="button" [class.active]="activeTab === 'export'" (click)="setTab('export')" data-testid="tab-export">
      Export
    </button>
    <button type="button" [class.active]="activeTab === 'import'" (click)="setTab('import')" data-testid="tab-import">
      Import
    </button>
  </nav>

  <section *ngIf="activeTab === 'overview'" class="tab-panel">
    <article class="card filters-card">
      <div class="period-switch">
        <button
          type="button"
          *ngFor="let value of ['week', 'month', 'year', 'custom']"
          [class.active]="period === value"
          (click)="setPeriodFromString(value)"
          [attr.data-testid]="'period-' + value"
        >
          {{ value | titlecase }}
        </button>
      </div>

      <div class="filter-grid">
        <div class="field" *ngIf="period === 'custom'">
          <label for="filterStartDate">Custom Start</label>
          <input id="filterStartDate" type="date" [(ngModel)]="filterStartDate" (ngModelChange)="recomputeSummary()" />
        </div>
        <div class="field" *ngIf="period === 'custom'">
          <label for="filterEndDate">Custom End</label>
          <input id="filterEndDate" type="date" [(ngModel)]="filterEndDate" (ngModelChange)="recomputeSummary()" />
        </div>

        <div class="field search-field">
          <label for="reportSearch">Search</label>
          <input
            id="reportSearch"
            type="search"
            [ngModel]="searchTerm"
            (ngModelChange)="onSearchChange($event)"
            placeholder="Category or transaction name"
            data-testid="reports-search-input"
          />
        </div>

        <div class="field">
          <label>Type</label>
          <div class="entry-types">
            <label>
              <input
                type="checkbox"
                [checked]="selectedEntryTypes.includes('expense')"
                (change)="onEntryTypeToggle('expense', $any($event.target).checked)"
              />
              Expense
            </label>
            <label>
              <input
                type="checkbox"
                [checked]="selectedEntryTypes.includes('income')"
                (change)="onEntryTypeToggle('income', $any($event.target).checked)"
              />
              Income
            </label>
          </div>
        </div>
      </div>

      <div class="category-filter" *ngIf="categoryOptions.length">
        <p>Categories</p>
        <div class="category-options">
          <label *ngFor="let category of categoryOptions; trackBy: trackByCategory">
            <input
              type="checkbox"
              [checked]="selectedCategoryIds.includes(category.id)"
              (change)="onCategoryToggle(category.id, $any($event.target).checked)"
            />
            {{ category.name }}
          </label>
        </div>
      </div>

      <button type="button" class="btn-secondary" (click)="clearFilters()">Reset Filters</button>
    </article>

    <div class="reports-skeleton" *ngIf="loading" aria-label="Loading report data">
      <div class="skeleton-summary-grid">
        <article class="skeleton-summary-card" *ngFor="let _ of [1, 2, 3]"></article>
      </div>
    </div>

    <ng-container *ngIf="!loading">
      <div class="summary-grid">
        <article class="summary-card">
          <p>Total Income ({{ period }})</p>
          <strong class="value-income">{{ formatCurrency(incomeTotal) }}</strong>
          <small>{{ summary?.income_count || 0 }} income entries</small>
        </article>

        <article class="summary-card">
          <p>Total Expense ({{ period }})</p>
          <strong class="value-expense">{{ formatCurrency(expenseTotal) }}</strong>
          <small>{{ summary?.expense_count || 0 }} expense entries</small>
        </article>

        <article class="summary-card">
          <p>Net Cashflow ({{ period }})</p>
          <strong [class.value-income]="netTotal >= 0" [class.value-expense]="netTotal < 0">{{ netTotal >= 0 ? '+' : '-' }}{{ formatCurrency(netTotal >= 0 ? netTotal : -netTotal) }}</strong>
          <small>Daily avg: {{ dailyNetAverage >= 0 ? '+' : '-' }}{{ formatCurrency(dailyNetAverage >= 0 ? dailyNetAverage : -dailyNetAverage) }}</small>
        </article>
      </div>

      <div class="chart-grid">
        <article class="card">
          <div class="card-head">
            <h2>Cashflow Trend</h2>
            <select [(ngModel)]="chartType">
              <option value="line">Line</option>
              <option value="bar">Bar</option>
            </select>
          </div>

          <div class="empty" *ngIf="!trendPoints.length">No transaction data for selected filters.</div>

          <div *ngIf="trendPoints.length && chartType === 'bar'" class="trend-bars">
            <div class="bar-item" *ngFor="let point of trendPoints">
              <div class="bar-track">
                <span class="bar-fill" [class.negative]="point.value < 0" [style.height.%]="barHeightPercent(point.value)"></span>
              </div>
              <small>{{ point.date.slice(5) }}</small>
            </div>
          </div>

          <div *ngIf="trendPoints.length && chartType === 'line'" class="line-chart-wrap">
            <svg viewBox="0 0 100 100" preserveAspectRatio="none" aria-label="Cashflow line chart">
              <polyline [attr.points]="lineChartPoints" fill="none" stroke="#064E3B" stroke-width="2"></polyline>
            </svg>
          </div>
        </article>

        <article class="card">
          <div class="card-head">
            <h2>Category Breakdown</h2>
            <select [(ngModel)]="breakdownChartType">
              <option value="donut">Donut</option>
              <option value="bar">Bar</option>
            </select>
          </div>

          <div class="empty" *ngIf="!categoryBreakdown.length">No transaction data for selected filters.</div>

          <div *ngIf="categoryBreakdown.length && breakdownChartType === 'donut'" class="donut-wrap">
            <div class="donut" [style.background]="donutStyle"></div>
          </div>

          <div *ngIf="categoryBreakdown.length && breakdownChartType === 'bar'" class="category-bars">
            <div class="category-row" *ngFor="let category of categoryBreakdown">
              <div class="category-head">
                <span>{{ category.name }}</span>
                <strong>{{ formatSignedAmount(category.total, category.entry_type) }}</strong>
              </div>
              <div class="category-progress">
                <span [style.width.%]="categoryPercent(category)" [style.backgroundColor]="category.color || '#064E3B'"></span>
              </div>
            </div>
          </div>

          <div class="category-list" *ngIf="categoryBreakdown.length">
            <div class="category-item" *ngFor="let category of categoryBreakdown.slice(0, 6)">
              <div class="left">
                <span class="dot" [style.backgroundColor]="category.color || '#064E3B'"></span>
                <div>
                  <p>
                    {{ category.name }}
                    <small class="type-chip" [class.income]="category.entry_type === 'income'" [class.expense]="category.entry_type !== 'income'">
                      {{ typeLabel(category.entry_type) }}
                    </small>
                  </p>
                </div>
              </div>
              <div class="right">
                <strong [class.value-income]="category.entry_type === 'income'" [class.value-expense]="category.entry_type !== 'income'">
                  {{ formatSignedAmount(category.total, category.entry_type) }}
                </strong>
              </div>
            </div>
          </div>
        </article>
      </div>
    </ng-container>
  </section>

  <section *ngIf="activeTab === 'export'" class="tab-panel">
    <article class="card">
      <h2>Export Transactions to CSV</h2>
      <p class="muted">Select a date range and download your income and expenses as a CSV file.</p>

      <div class="date-grid">
        <div class="field">
          <label for="fromDate">From</label>
          <input id="fromDate" type="date" [(ngModel)]="fromDate" data-testid="export-from-date" />
        </div>
        <div class="field">
          <label for="toDate">To</label>
          <input id="toDate" type="date" [(ngModel)]="toDate" data-testid="export-to-date" />
        </div>
      </div>

      <button type="button" class="btn-primary" (click)="exportCsv()" data-testid="export-btn">Download CSV</button>
    </article>
  </section>

  <section *ngIf="activeTab === 'import'" class="tab-panel">
    <article class="card">
      <h2>Import Transactions from CSV</h2>

      <div class="hint">
        <p>Required CSV format:</p>
        <code>Date,Description,Amount,Type,Currency,Category,Subcategory</code>
        <code>2024-01-15,Coffee,5.50,expense,USD,Food &amp; Dining,Coffee &amp; Snacks</code>
      </div>

      <textarea
        [(ngModel)]="importData"
        placeholder="Paste your CSV data here (including header row)..."
        data-testid="import-textarea"
      ></textarea>

      <button
        type="button"
        class="btn-primary"
        [disabled]="importing || !importData.trim()"
        (click)="importCsv()"
        data-testid="import-btn"
      >
        {{ importing ? 'Importing...' : 'Import Transactions' }}
      </button>
    </article>
  </section>
</div>
